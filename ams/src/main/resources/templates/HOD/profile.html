<!DOCTYPE html>
<html
  class="loading"
  lang="en"
  data-textdirection="ltr"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <title>Attendance Management System</title>
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet" />
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet" />

    <link href="assets/css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div th:replace="~{HOD/nav :: body}"></div>
    <main id="main" class="main">
      <div class="pagetitle">
        <h1>Profile</h1>
        <nav>
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item active">Profile</li>
          </ol>
        </nav>
      </div>

      <section class="section profile">
        <div class="col-xl-12">
          <div class="card">
            <div class="card-body pt-3">
              <ul class="nav nav-tabs nav-tabs-bordered justify-content-center">
                <li class="nav-item">
                  <button
                    class="nav-link active"
                    data-bs-toggle="tab"
                    data-bs-target="#profile-overview"
                  >
                    Profile
                  </button>
                </li>

                <li class="nav-item">
                  <button
                    class="nav-link"
                    data-bs-toggle="tab"
                    data-bs-target="#profile-edit"
                  >
                    Edit Profile
                  </button>
                </li>

                <li class="nav-item">
                  <button
                    class="nav-link"
                    data-bs-toggle="tab"
                    data-bs-target="#profile-change-password"
                  >
                    Change Password
                  </button>
                </li>
              </ul>
              <div class="tab-content pt-2">
                <div
                  class="tab-pane fade show active profile-overview"
                  id="profile-overview"
                >
                  <div class="row">
                    <h5 class="card-title">Profile Details</h5>
                    <hr class="divider" />

                    <div class="col-4">
                      <div class="profile-card">
                        <img
                          th:src="@{${userDetails.image}}"
                          alt="Profile"
                          class="profile-img"
                        />
                        <h2
                          th:text="${userDetails.fname + ' ' + userDetails.lname}"
                        ></h2>
                      </div>
                    </div>

                    <div class="col-8">
                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">Full Name :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.fname + ' ' + userDetails.mname + ' ' + userDetails.lname}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">Faculty :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.facultyid.faculty}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">Department :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.departmentid.department}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">Education :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.qualification}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">
                          Contact Number :
                        </div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.contactnumber}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">
                          Personal Email :
                        </div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.personalemail}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">GVP Email :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.gvpemail}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">
                          Date of Birth :
                        </div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${#dates.format(userDetails.dob, 'dd/MM/yyyy')}"
                        ></div>
                      </div>

                      <div class="row detail-row">
                        <div class="col-lg-4 col-md-4 label">Address :</div>
                        <div
                          class="col-lg-8 col-md-8"
                          th:text="${userDetails.address}"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade profile-edit pt-3" id="profile-edit">
                  <form
                    class="row mb-3"
                    id="profileForm"
                    th:action="@{/updatetHODProfile}"
                    method="post"
                    onsubmit="return validateForm()"
                    enctype="multipart/form-data"
                  >
                    <input
                      type="hidden"
                      id="editteacherid"
                      name="teacherid"
                      th:value="${userDetails.teacherid}"
                    />

                    <div class="row mb-3">
                      <label
                        for="profileImageInput"
                        class="col-md-4 col-lg-3 col-form-label"
                        ><i class="fa fa-camera"></i> Profile Image</label
                      >
                      <div class="col-md-8 col-lg-9">
                        <div class="profile-container">
                          <img
                            th:src="@{${userDetails.image}}"
                            alt="Profile"
                            class="profile-img"
                          />
                          <span class="edit-icon"
                            ><i class="fa fa-camera"></i
                          ></span>
                          <input
                            type="file"
                            name="profileImageInput"
                            id="profileImageInput"
                            style="display: none"
                          />
                          <p id="profileImageError" class="error-message"></p>
                        </div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label
                        for="fullName"
                        class="col-md-4 col-lg-4 col-form-label"
                        ><i class="fas fa-user"></i> Full Name</label
                      >
                      <div class="form-group d-flex justify-content-between">
                        <input
                          name="fname"
                          type="text"
                          class="form-control"
                          id="editfname"
                          style="width: 32.5%"
                          th:value="${userDetails.fname}"
                        />
                        <input
                          name="mname"
                          type="text"
                          class="form-control"
                          id="editmname"
                          style="width: 32.5%"
                          th:value="${userDetails.mname}"
                        />
                        <input
                          name="lname"
                          type="text"
                          class="form-control"
                          id="editlname"
                          style="width: 32.5%"
                          th:value="${userDetails.lname}"
                        />
                      </div>
                      <p id="editnameError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label
                        for="dateOfBirth"
                        class="col-md-4 col-lg-4 col-form-label"
                        ><i class="fas fa-calendar-alt"></i> Date of
                        Birth</label
                      >
                      <input
                        type="date"
                        class="form-control"
                        name="dob"
                        id="editdateOfBirth"
                        th:value="${#dates.format(userDetails.dob, 'yyyy-MM-dd')}"
                      />
                      <p id="editdobError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label
                        for="email"
                        class="col-md-4 col-lg-4 col-form-label"
                        ><i class="fas fa-envelope"></i> Email</label
                      >
                      <input
                        name="email"
                        type="text"
                        class="form-control"
                        id="editemail"
                        th:value="${userDetails.personalemail}"
                      />
                      <p id="editemailError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label
                        for="contactNumber"
                        class="col-md-4 col-lg-4 col-form-label"
                        ><i class="fas fa-phone-alt"></i> Phone</label
                      >
                      <input
                        name="contactNo"
                        type="text"
                        class="form-control"
                        id="editcontactNumber"
                        th:value="${userDetails.contactnumber}"
                      />
                      <p id="editcontactNoError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label
                        for="address"
                        class="col-md-4 col-lg-4 col-form-label"
                        ><i class="fas fa-map-marker-alt"></i> Address</label
                      >
                      <textarea
                        class="form-control"
                        name="address"
                        id="editaddress"
                        style="height: 100px"
                        th:text="${userDetails.address}"
                      ></textarea>
                      <p id="editaddressError" class="error-message"></p>
                    </div>

                    <div class="col-12">
                      <button
                        type="submit"
                        class="btn btn-custom"
                        style="width: 150px"
                      >
                        Save Changes
                      </button>
                    </div>
                  </form>
                </div>

                <div
                  class="tab-pane profile-change-password fade pt-3"
                  id="profile-change-password"
                >
                  <form
                    class="row mb-3"
                    th:action="@{/changeHODPassword}"
                    method="post"
                    onsubmit="return validatePasswordForm()"
                  >
                    <input
                      type="hidden"
                      id="email"
                      name="email"
                      th:value="${userDetails.gvpemail}"
                    />

                    <div class="col-md-12 mb-3">
                      <label for="oldpassword"
                        ><i class="fas fa-key"></i> Old Password</label
                      >
                      <div class="password-container">
                        <input
                          type="password"
                          class="form-control"
                          id="oldpassword"
                          name="oldPassword"
                          placeholder="Old Password"
                          onblur="validateOldPassword()"
                        />
                        <i
                          class="fas fa-eye-slash toggle-password"
                          onclick="togglePasswordVisibility('oldpassword', this)"
                        ></i>
                      </div>
                      <p id="oldpasswordError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label for="newpassword"
                        ><i class="fas fa-unlock-alt"></i> New Password</label
                      >
                      <div class="password-container">
                        <input
                          type="password"
                          class="form-control"
                          id="newpassword"
                          name="newPassword"
                          placeholder="New Password"
                          onblur="validateNewPassword()"
                        />
                        <i
                          class="fas fa-eye-slash toggle-password"
                          onclick="togglePasswordVisibility('newpassword', this)"
                        ></i>
                      </div>
                      <p id="newpasswordError" class="error-message"></p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label for="confirmpassword"
                        ><i class="fas fa-lock"></i> Confirm New Password</label
                      >
                      <div class="password-container">
                        <input
                          type="password"
                          class="form-control"
                          id="confirmpassword"
                          name="confirmpassword"
                          placeholder="Confirm New Password"
                          onblur="validateConfirmPassword()"
                        />
                        <i
                          class="fas fa-eye-slash toggle-password"
                          onclick="togglePasswordVisibility('confirmpassword', this)"
                        ></i>
                      </div>
                      <p id="confirmpasswordError" class="error-message"></p>
                    </div>

                    <div class="col-12">
                      <button type="submit" class="btn btn-custom">
                        Change Password
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      document
        .querySelector(".edit-icon")
        .addEventListener("click", function () {
          document.getElementById("profileImageInput").click();
        });

      function togglePasswordVisibility(inputFieldId, iconElement) {
        var passwordField = document.getElementById(inputFieldId);
        var icon = iconElement;

        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
          setTimeout(function () {
            passwordField.type = "password";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
          }, 1500);
        } else {
          passwordField.type = "password";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        }
      }
    </script>

    <script>
      function validateOldPassword() {
        const oldPasswordField = document.getElementById("oldpassword");
        const oldPasswordValue = oldPasswordField.value.trim();
        const oldPasswordError = document.getElementById("oldpasswordError");

        if (!oldPasswordValue) {
          oldPasswordError.textContent = "Old Password cannot be empty";
          return false;
        }

        fetch("/validateOldPassword", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            email: document.getElementById("email").value,
            oldPassword: oldPasswordValue,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.isValid) {
              oldPasswordError.textContent = "Old password is incorrect.";
            } else {
              oldPasswordError.textContent = "";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function validateNewPassword() {
        const newPasswordField = document.getElementById("newpassword");
        const newPasswordValue = newPasswordField.value.trim();
        const newPasswordError = document.getElementById("newpasswordError");

        const passwordRegex =
          /^(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%^&*])[A-Za-z0-9!@#$%^&*]{8,}$/;

        if (!newPasswordValue) {
          newPasswordError.textContent = "Please enter valid password";
          return false;
        } else if (!passwordRegex.test(newPasswordValue)) {
          newPasswordError.textContent =
            "Password must be at least 8 characters long and include special character, alphabet, and number";
          return false;
        } else {
          newPasswordError.textContent = "";
        }

        return true;
      }

      function validateConfirmPassword() {
        const confirmPasswordField = document.getElementById("confirmpassword");
        const confirmPasswordValue = confirmPasswordField.value.trim();
        const confirmPasswordError = document.getElementById(
          "confirmpasswordError"
        );
        const newPasswordValue = document
          .getElementById("newpassword")
          .value.trim();

        if (!confirmPasswordValue) {
          confirmPasswordError.textContent = "Please enter valid password";
          return false;
        }

        if (newPasswordValue !== confirmPasswordValue) {
          confirmPasswordError.textContent = "Passwords do not match";
          return false;
        } else {
          confirmPasswordError.textContent = "";
        }

        return true;
      }

      function validatePasswordForm() {
        let isValid = true;

        validateOldPassword();
        if (document.getElementById("oldpasswordError").textContent)
          isValid = false;

        validateNewPassword();
        if (document.getElementById("newpasswordError").textContent)
          isValid = false;

        validateConfirmPassword();
        if (document.getElementById("confirmpasswordError").textContent)
          isValid = false;

        return isValid;
      }

      document
        .getElementById("oldpasswordError")
        .addEventListener("blur", validateoldpassword);
      document
        .getElementById("newpasswordError")
        .addEventListener("blur", validatenewpassword);
      document
        .getElementById("confirmpasswordError")
        .addEventListener("blur", validateconfirmpassword);
    </script>

    <script>
      function validateemail() {
        const email = document.getElementById("editemail").value;
        const errorElement = document.getElementById("editemailError");
        if (
          email.length < 5 ||
          email.length > 255 ||
          !/\S+@\S+\.\S+/.test(email)
        ) {
          errorElement.textContent = "Please enter a valid email address";
        } else {
          errorElement.textContent = "";
        }
      }

      function validateaddress() {
        const address = document.getElementById("editaddress").value;
        const errorElement = document.getElementById("editaddressError");
        if (address.length < 10 || address.length > 255) {
          errorElement.textContent = "Please enter a valid address";
        } else {
          errorElement.textContent = "";
        }
      }

      function validatephone() {
        const phone = document.getElementById("editcontactNumber").value;
        const errorElement = document.getElementById("editcontactNoError");
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(phone)) {
          errorElement.textContent = "Please enter a valid contact number";
        } else {
          errorElement.textContent = "";
        }
      }

      function validatename() {
        const fname = document.getElementById("editfname").value;
        const mname = document.getElementById("editmname").value;
        const lname = document.getElementById("editlname").value;
        const errorElement = document.getElementById("editnameError");
        if (
          fname.length < 2 ||
          fname.length > 255 ||
          mname.length < 2 ||
          mname.length > 255 ||
          lname.length < 2 ||
          lname.length > 255
        ) {
          errorElement.textContent = "Please enter a valid name";
          return false;
        } else {
          errorElement.textContent = "";
          return true;
        }
      }

      function validatedob() {
        const dob = document.getElementById("editdateOfBirth").value;
        const errorElement = document.getElementById("editdobError");
        const cutoffDate = new Date("2003-01-01");
        const dobDate = new Date(dob);

        if (!dob) {
          errorElement.textContent = "Please enter a valid date of birth";
        } else if (dobDate >= cutoffDate) {
          errorElement.textContent = "Please enter a valid date of birth";
        } else {
          errorElement.textContent = "";
        }
      }

      function validateprofileimage() {
        const profileImage =
          document.getElementById("profileImageInput").files[0];
        const errorElement = document.getElementById("profileImageError");
        if (profileImage && profileImage.size > 2 * 1024 * 1024) {
          errorElement.textContent = "Please enter valid profile image";
        } else {
          errorElement.textContent = "";
        }
      }

      function validateForm() {
        let isValid = true;

        validatename();
        if (document.getElementById("editnameError").textContent)
          isValid = false;

        validateemail();
        if (document.getElementById("editemailError").textContent)
          isValid = false;

        validateaddress();
        if (document.getElementById("editaddressError").textContent)
          isValid = false;

        validatephone();
        if (document.getElementById("editcontactNoError").textContent)
          isValid = false;

        validatedob();
        if (document.getElementById("editdobError").textContent)
          isValid = false;

        validateprofileimage();
        if (document.getElementById("profileImageError").textContent)
          isValid = false;

        return isValid;
      }

      document
        .getElementById("editemail")
        .addEventListener("blur", validateemail);
      document
        .getElementById("editaddress")
        .addEventListener("blur", validateaddress);
      document
        .getElementById("editcontactNumber")
        .addEventListener("blur", validatephone);
      document
        .getElementById("editfname")
        .addEventListener("blur", validatename);
      document
        .getElementById("editlname")
        .addEventListener("blur", validatename);
      document
        .getElementById("editdateOfBirth")
        .addEventListener("blur", validatedob);
      document
        .getElementById("profileImageInput")
        .addEventListener("change", validateprofileimage);
    </script>

    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/chart.js/chart.umd.js"></script>
    <script src="assets/vendor/echarts/echarts.min.js"></script>
    <script src="assets/vendor/quill/quill.js"></script>
    <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <script src="assets/js/main.js"></script>
  </body>
</html>
